# /*---------------------------------------------------------------------------8
# |                                                                            |
# |       This workflows deploys the control plane with GitHub Actions         |
# |                                                                            |
# +------------------------------------4--------------------------------------*/

name:                                             01 - Deploy Control Plane
run-name:                                         Deploy Control Plane by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      control_plane_name:
        description:                              'Control Plane configuration name, use the following syntax: ENV-LOCA-VNET'
        required:                                 true
        type:                                     environment
      force_reset:
        description:                              'Force a re-install - may require multiple re-runs'
        required:                                 false
        type:                                     boolean
        default:                                  false
      test:
        description:                              'Only run Terraform plan'
        required:                                 false
        type:                                     boolean
        default:                                  false
permissions:
  contents:                                       write
  id-token:                                       write
  issues:                                         write

env:
  TF_IN_AUTOMATION:                               ${{ vars.TF_IN_AUTOMATION }}
  TF_LOG:                                         ${{ vars.TF_LOG }}
  ANSIBLE_CORE_VERSION:                           ${{ vars.ANSIBLE_CORE_VERSION }}
  TF_VERSION:                                     ${{ vars.TF_VERSION }}

jobs:
  prepare-deployer:
    name:                                         Prepare Deployer
    environment:                                  ${{ inputs.control_plane_name }}
    runs-on:                                      ubuntu-latest
    container:
      image:                                      ${{ vars.DOCKER_IMAGE }}
    outputs:
      this_agent:                                 ${{ steps.prepare_control_plane.outputs.this_agent }}
      deployer_keyvault:                          ${{ steps.prepare_control_plane.outputs.deployer_keyvault }}
      app_config_name:                            ${{ steps.prepare_control_plane.outputs.app_config_name }}
      msi_id:                                     ${{ steps.prepare_control_plane.outputs.msi_id }}

    steps:
      - name:                                     Get app token
        id:                                       get_workflow_token
        uses:                                     actions/create-github-app-token@v2
        with:
          app-id:                                 ${{ secrets.APPLICATION_ID }}
          private-key:                            ${{ secrets.APPLICATION_PRIVATE_KEY }}

      - name:                                     Checkout repository
        uses:                                     actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth:                            0
          token:                                  ${{ secrets.GITHUB_TOKEN }}

      - name:                                     Configure Git Safe Directory
        run:                                      |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "/__w/${{ github.event.repository.name }}/${{ github.event.repository.name }}"

      - name:                                     Azure Login with Service Principal
        if:                                       ${{ vars.USE_MSI != 'true' }}
        uses:                                     Azure/Login@v2
        with:
          client-id:                              ${{ vars.ARM_CLIENT_ID }}
          tenant-id:                              ${{ vars.ARM_TENANT_ID }}
          subscription-id:                        ${{ vars.ARM_SUBSCRIPTION_ID }}

      - name:                                     Azure Login with initial Service Principal to create the self-hosted runner
        if:                                       ${{ vars.USE_MSI == 'true' }}
        uses:                                     Azure/Login@v2
        with:
          client-id:                              ${{ vars.ARM_SPN_CLIENT_ID }}
          tenant-id:                              ${{ vars.ARM_TENANT_ID }}
          subscription-id:                        ${{ vars.ARM_SUBSCRIPTION_ID }}

      - name:                                     Prepare Control Plane
        id:                                       prepare_control_plane
        run:                                      |
          echo "Running control plane preparation"
          cd ${SAP_AUTOMATION_REPO_PATH}
          bash deploy/scripts/pipeline_scripts/v2/01-control-plane-prepare.sh
        env:
          CONTROL_PLANE_NAME:                     ${{ inputs.control_plane_name }}
          APPLICATION_CONFIGURATION_NAME:         ${{ vars.APPLICATION_CONFIGURATION_NAME }}
          FORCE_RESET:                            ${{ inputs.force_reset }}
          IS_PIPELINE_DEPLOYMENT:                 true
          ARM_CLIENT_ID:                          ${{ vars.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET:                      ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID:                    ${{ vars.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID:                          ${{ vars.ARM_TENANT_ID }}
          WEB_APP_CLIENT_SECRET:                  ${{ secrets.WEB_APP_CLIENT_SECRET }}
          TF_VAR_agent_pool:                      'Default'
          TF_VAR_spn_id:                          ${{ vars.ARM_CLIENT_ID }}
          TF_VAR_ansible_core_version:            ${{ env.ANSIBLE_CORE_VERSION }}
          TF_VAR_tf_version:                      ${{ env.TF_VERSION }}
          TF_VAR_app_registration_app_id:         ${{ vars.APP_REGISTRATION_APP_ID }}
          APP_TOKEN:                              ${{ steps.get_workflow_token.outputs.token }}
          TF_VAR_github_app_token:                ${{ steps.get_workflow_token.outputs.token }}
          ZONE:                                   ${{ inputs.control_plane_name }}

  populate-keyvault:
    name:                                         Save Deployment Credentials in Azure Keyvault
    environment:                                  ${{ inputs.control_plane_name }}
    needs:                                        prepare-deployer
    runs-on:                                      self-hosted
    container:
      image:                                      ${{ vars.DOCKER_IMAGE }}

    steps:
      - name:                                     Checkout repository
        uses:                                     actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          token:                                  ${{ secrets.GITHUB_TOKEN }}
          fetch-depth:                            0
          ref:                                    ${{ github.ref }}
          clean:                                  true

      - name:                                     Configure Git Safe Directory
        run:                                      |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "/__w/${{ github.event.repository.name }}/${{ github.event.repository.name }}"

      - name:                                     Get app token
        id:                                       get_workflow_token
        uses:                                     actions/create-github-app-token@v2
        with:
          app-id:                                 ${{ secrets.APPLICATION_ID }}
          private-key:                            ${{ secrets.APPLICATION_PRIVATE_KEY }}

      - name:                                     Azure Login with Managed Identity
        if:                                       ${{ vars.USE_MSI == 'true' }}
        uses:                                     Azure/login@v2
        with:
          auth-type:                              IDENTITY
          tenant-id:                              ${{ vars.ARM_TENANT_ID }}
          subscription-id:                        ${{ vars.ARM_SUBSCRIPTION_ID }}

      - name:                                     Azure Login with Service Principal
        if:                                       ${{ vars.USE_MSI != 'true' }}
        uses:                                     Azure/Login@v2
        with:
          creds:                                  |
           {
                                                  "clientId": "${{ vars.ARM_CLIENT_ID }}",
                                                  "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
                                                  "subscriptionId": "${{ vars.ARM_SUBSCRIPTION_ID }}",
                                                  "tenantId": "${{ vars.ARM_TENANT_ID }}"
           }
      - name:                                     Azure Login with Service Principal
        if:                                       ${{ vars.USE_MSI != 'true' }}
        uses:                                     Azure/Login@v2
        with:
          client-id:                              ${{ vars.ARM_CLIENT_ID }}
          tenant-id:                              ${{ vars.ARM_TENANT_ID }}
          subscription-id:                        ${{ vars.ARM_SUBSCRIPTION_ID }}

      - name:                                     Store Secrets in Keyvault
        id:                                       store_secrets_in_keyvault
        run:                                      |
          cd ${SAP_AUTOMATION_REPO_PATH}
          bash deploy/scripts/pipeline_scripts/00-store-secrets-in-keyvault.sh
        env:
          APPLICATION_CONFIGURATION_NAME:         ${{ vars.APPLICATION_CONFIGURATION_NAME }}
          APP_TOKEN:                              ${{ steps.get_workflow_token.outputs.token }}
          ARM_CLIENT_ID:                          ${{ vars.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET:                      ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_OBJECT_ID:                          ${{ vars.ARM_OBJECT_ID }}
          ARM_SUBSCRIPTION_ID:                    ${{ vars.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID:                          ${{ vars.ARM_TENANT_ID }}
          CONTROL_PLANE_NAME:                     ${{ inputs.control_plane_name }}
          DEPLOYER_KEYVAULT:                      ${{ vars.DEPLOYER_KEYVAULT }}
          GH_PAT:                                 ${{ secrets.PAT }}
          TF_VAR_agent_pool:                      'Default'
          TF_VAR_ansible_core_version:            ${{ env.ANSIBLE_CORE_VERSION }}
          TF_VAR_app_registration_app_id:         ${{ vars.APP_REGISTRATION_APP_ID }}
          TF_VAR_github_app_token:                ${{ steps.get_workflow_token.outputs.token }}
          TF_VAR_tf_version:                      ${{ env.TF_VERSION }}
          USE_MSI:                                ${{ vars.USE_MSI }}
          ZONE:                                   ${{ inputs.control_plane_name }}

  deploy-control-plane:
    name:                                         Deploy Control Plane
    environment:                                  ${{ inputs.control_plane_name }}
    needs:                                        [prepare-deployer, populate-keyvault]
    runs-on:                                      self-hosted
    container:
      image:                                      ${{ vars.DOCKER_IMAGE }}
    outputs:
      HAS_WEBAPP:                                 ${{ steps.deploy_control_plane.outputs.HAS_WEBAPP }}
      APPSERVICE_NAME:                            ${{ steps.deploy_control_plane.outputs.APPSERVICE_NAME }}

    steps:

      - name:                                     Configure Git Safe Directory
        run:                                      |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "/__w/${{ github.event.repository.name }}/${{ github.event.repository.name }}"

      - name:                                     Checkout repository
        uses:                                     actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth:                            0
          ref:                                    ${{ github.ref }}
          clean:                                  true
          token:                                  ${{ secrets.GITHUB_TOKEN }}

      - name:                                     Get app token
        id:                                       get_workflow_token
        uses:                                     actions/create-github-app-token@v2
        with:
          app-id:                                 ${{ secrets.APPLICATION_ID }}
          private-key:                            ${{ secrets.APPLICATION_PRIVATE_KEY }}

      - name:                                     Azure Login with Managed Identity
        if:                                       ${{ vars.USE_MSI == 'true' }}
        uses:                                     Azure/login@v2
        with:
          auth-type:                              IDENTITY
          tenant-id:                              ${{ vars.ARM_TENANT_ID }}
          subscription-id:                        ${{ vars.ARM_SUBSCRIPTION_ID }}

      - name:                                     Azure Login with Service Principal
        if:                                       ${{ vars.USE_MSI != 'true' }}
        uses:                                     Azure/Login@v2
        with:
          client-id:                              ${{ vars.ARM_CLIENT_ID }}
          tenant-id:                              ${{ vars.ARM_TENANT_ID }}
          subscription-id:                        ${{ vars.ARM_SUBSCRIPTION_ID }}

      - name:                                     Deploy Control Plane
        id:                                       deploy_control_plane
        run:                                      |
          echo "Running control plane deployment"
          cd ${SAP_AUTOMATION_REPO_PATH}
          bash deploy/scripts/pipeline_scripts/01-control-plane-deploy.sh
        env:
          APPLICATION_CONFIGURATION_NAME:         ${{ vars.APPLICATION_CONFIGURATION_NAME }}
          APP_REGISTRATION_APP_ID:                ${{ vars.APP_REGISTRATION_APP_ID }}
          APP_TOKEN:                              ${{ steps.get_workflow_token.outputs.token }}
          ARM_CLIENT_ID:                          ${{ vars.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET:                      ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_OBJECT_ID:                          ${{ vars.ARM_OBJECT_ID }}
          ARM_SUBSCRIPTION_ID:                    ${{ vars.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID:                          ${{ vars.ARM_TENANT_ID }}
          ARM_USE_MSI:                            ${{ vars.USE_MSI }}
          CONTROL_PLANE_NAME:                     ${{ inputs.control_plane_name }}
          DEPLOYER_KEYVAULT:                      ${{ vars.DEPLOYER_KEYVAULT }}
          DEPLOYER_TFSTATE_KEY:                   "${{ inputs.control_plane_name }}-INFRASTRUCTURE.terraform.tfstate"
          FORCE_RESET:                            ${{ inputs.force_reset }}
          IS_PIPELINE_DEPLOYMENT:                 true
          TF_VAR_agent_pool:                      'Default'
          TF_VAR_ansible_core_version:            ${{ env.ANSIBLE_CORE_VERSION }}
          TF_VAR_app_registration_app_id:         ${{ vars.APP_REGISTRATION_APP_ID }}
          TF_VAR_github_app_token:                ${{ steps.get_workflow_token.outputs.token }}
          TF_VAR_subscription_id:                 ${{ vars.ARM_SUBSCRIPTION_ID }}
          TF_VAR_tf_version:                      ${{ env.TF_VERSION }}
          USE_MSI:                                ${{ vars.USE_MSI }}
          ZONE:                                   ${{ inputs.control_plane_name }}
          tf_version:                             ${{ env.TF_VERSION }}

  deploy-web-app:
    name:                                         Deploy SAP Configuration Web App
    needs:                                        [prepare-deployer, deploy-control-plane]
    if:                                           needs.deploy-control-plane.outputs.HAS_WEBAPP == 'true'
    runs-on:                                      ${{ needs.prepare-deployer.outputs.this_agent || 'ubuntu-latest' }}

    steps:
      - name:                                     Checkout repository
        uses:                                     actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          path:                                   sap-automation

      - name:                                     Setup .NET Core
        uses:                                     actions/setup-dotnet@v4
        with:
          dotnet-version:                         '7.0.x'

      - name:                                     Build Web Application
        run:                                      |
          dotnet build "${{ github.workspace }}/sap-automation/Webapp/SDAF/*.csproj"

      - name:                                     Publish Web Application
        run:                                      |
          dotnet publish "${{ github.workspace }}/sap-automation/Webapp/SDAF/*.csproj" --output webapp-publish --configuration Release
          cd webapp-publish
          zip -r ../webapp.zip *

      - name:                                     Azure Login with Managed Identity
        if:                                       ${{ vars.USE_MSI == 'true' }}
        uses:                                     Azure/login@v2
        with:
          auth-type:                              IDENTITY
          tenant-id:                              ${{ vars.ARM_TENANT_ID }}
          subscription-id:                        ${{ vars.ARM_SUBSCRIPTION_ID }}

      - name:                                     Azure Login with Service Principal
        if:                                       ${{ vars.USE_MSI != 'true' }}
        uses:                                     Azure/Login@v2
        with:
          client-id:                              ${{ vars.ARM_CLIENT_ID }}
          tenant-id:                              ${{ vars.ARM_TENANT_ID }}
          subscription-id:                        ${{ vars.ARM_SUBSCRIPTION_ID }}

      - name:                                     Deploy Web App
        uses:                                     azure/webapps-deploy@v3
        with:
          app-name:                               ${{ needs.deploy-control-plane.outputs.APPSERVICE_NAME }}
          package:                                webapp.zip
          startup-command:                        ''

      - name:                                     Configure Web App
        run:                                      |
          az webapp config appsettings set --name ${{ needs.deploy-control-plane.outputs.APPSERVICE_NAME }} \
            --settings \
            'CollectionUri=${{ github.server_url }}' \
            'ProjectName=${{ github.repository }}' \
            'RepositoryId=${{ github.repository }}' \
            'SourceBranch=${{ github.ref_name }}' \
            'IS_PIPELINE_DEPLOYMENT=true' \
            'CONTROL_PLANE_NAME=${{ inputs.control_plane_name }}'

      - name:                                     Document Web App Configuration Steps
        run:                                      |
          echo "Web App Configuration Steps"
          cd ${SAP_AUTOMATION_REPO_PATH}
          bash deploy/scripts/pipeline_scripts/01-webapp-configuration.sh
        env:
          CONTROL_PLANE_NAME:                     ${{ inputs.control_plane_name }}
          APP_REGISTRATION_APP_ID:                ${{ env.APP_REGISTRATION_APP_ID }}
